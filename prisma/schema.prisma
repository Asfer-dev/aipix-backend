// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * CORE: ROLES, ORGS, USERS
 * =========================
 */

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users UserRole[]
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())

  users         User[]
  projects      Project[]
  listings      Listing[]
  subscriptions Subscription[]
}

model User {
  id              Int       @id @default(autoincrement())
  organizationId  Int?
  email           String    @unique
  passwordHash    String
  displayName     String
  isActive        Boolean   @default(true)
  mfaEnabled      Boolean   @default(false)
  mfaSecret       String? // secret used for TOTP
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  organization            Organization?            @relation(fields: [organizationId], references: [id])
  roles                   UserRole[]
  projects                Project[]
  jobs                    Job[]                    @relation("JobsCreatedBy")
  listings                Listing[]                @relation("UserListings")
  bookings                Booking[]                @relation("BuyerBookings")
  messagesSent            Message[]                @relation("MessagesSent")
  messagesReceived        Message[]                @relation("MessagesReceived")
  moderationActions       ModerationAction[]
  flagsRaised             ModerationFlag[]         @relation("FlagsRaisedBy")
  subscriptions           Subscription[]
  auditLogs               AuditLog[]
  listingFavorites        ListingFavorite[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  enhancementJobs         EnhancementJob[]

  projectAdCopies         ProjectAdCopy[]
}

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model EmailVerificationToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

/**
 * =========================
 * PLANS, SUBSCRIPTIONS, CREDITS
 * =========================
 */

model Plan {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  description     String?
  monthlyPriceUsd Decimal  @db.Decimal(10, 2)
  maxAiCredits    Int
  maxStorageMb    Int
  createdAt       DateTime @default(now())

  subscriptions Subscription[]
}

model Subscription {
  id             Int       @id @default(autoincrement())
  organizationId Int?
  userId         Int?
  planId         Int
  startDate      DateTime
  endDate        DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  plan         Plan          @relation(fields: [planId], references: [id])
  creditUsages CreditUsage[]
}

model CreditUsage {
  id             Int  @id @default(autoincrement())
  subscriptionId Int
  jobId          Int?

  creditsUsed Int
  reason      String?
  createdAt   DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  job          Job?         @relation(fields: [jobId], references: [id])

  @@index([subscriptionId])
  @@index([jobId])
}

/**
 * =========================
 * PROJECTS, JOBS & MEDIA
 * =========================
 */

enum ImageVersionType {
  ORIGINAL
  ENHANCED
  STAGED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model Project {
  id         Int      @id @default(autoincrement())
  userId     Int
  name       String
  clientName String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner           User             @relation(fields: [userId], references: [id])
  images          Image[]
  organization    Organization?    @relation(fields: [organizationId], references: [id])
  organizationId  Int?
  enhancementJobs EnhancementJob[]
  jobs            Job[]
  listings        Listing[]

  // NEW: project-scoped ad/listing copy templates
  adCopies        ProjectAdCopy[]

  @@index([userId])
}

model ProjectAdCopy {
  id          Int      @id @default(autoincrement())
  projectId   Int
  channel     String   // e.g. 'AIPIX', 'FACEBOOK', 'PORTAL_X'
  title       String
  description String
  keywords    String?
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id])
  createdBy User    @relation(fields: [createdById], references: [id])

  @@index([projectId])
  @@index([createdById])
}

model Image {
  id          Int      @id @default(autoincrement())
  projectId   Int
  originalUrl String
  label       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project         Project          @relation(fields: [projectId], references: [id])
  versions        ImageVersion[]
  enhancementJobs EnhancementJob[]
  jobs            Job[]

  @@index([projectId])
}

model ImageVersion {
  id        Int              @id @default(autoincrement())
  imageId   Int
  type      ImageVersionType
  url       String
  metadata  Json?
  createdAt DateTime         @default(now())

  image           Image            @relation(fields: [imageId], references: [id])
  listingMedias   ListingMedia[]
  moderationFlags ModerationFlag[]

  @@index([imageId, type])
}

model EnhancementJob {
  id           Int       @id @default(autoincrement())
  userId       Int
  projectId    Int
  imageId      Int
  status       JobStatus @default(PENDING)
  errorMessage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  image   Image   @relation(fields: [imageId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([imageId])
}

model Job {
  id           Int       @id @default(autoincrement())
  userId       Int
  projectId    Int
  imageId      Int
  status       JobStatus @default(PENDING)
  errorMessage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user         User          @relation("JobsCreatedBy", fields: [userId], references: [id])
  project      Project       @relation(fields: [projectId], references: [id])
  image        Image         @relation(fields: [imageId], references: [id])
  creditUsages CreditUsage[]

  @@index([userId])
  @@index([projectId])
  @@index([imageId])
}

/**
 * =========================
 * MARKETPLACE: LISTINGS, MEDIA, BOOKINGS, MESSAGES
 * =========================
 */

enum ListingStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Listing {
  id              Int           @id @default(autoincrement())
  userId          Int
  projectId       Int
  title           String
  description     String?
  price           Float?
  currency        String? // e.g. "USD", "NGN"
  status          ListingStatus @default(DRAFT)
  isPublished     Boolean       @default(false)
  locationCity    String?
  locationState   String?
  locationCountry String?
  propertyType    String? // "Apartment", "House", etc.
  bedrooms        Int?
  bathrooms       Int?
  areaSqm         Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user             User              @relation("UserListings", fields: [userId], references: [id])
  project          Project           @relation(fields: [projectId], references: [id])
  media            ListingMedia[]
  organization     Organization?     @relation(fields: [organizationId], references: [id])
  organizationId   Int?
  listingFavorites ListingFavorite[]
  bookings         Booking[]
  messages         Message[]
  listingAds       ListingAd[]
  listingExports   ListingExport[]
  moderationFlags  ModerationFlag[]

  @@index([status])
  @@index([isPublished])
  @@index([locationCity])
  @@index([locationCountry])
}

model ListingMedia {
  id             Int     @id @default(autoincrement())
  listingId      Int
  imageVersionId Int
  isHero         Boolean @default(false)
  sortOrder      Int     @default(0)

  listing      Listing      @relation(fields: [listingId], references: [id])
  imageVersion ImageVersion @relation(fields: [imageVersionId], references: [id])

  @@index([listingId])
  @@index([imageVersionId])
}

model ListingFavorite {
  userId    Int
  listingId Int
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])

  @@id([userId, listingId])
}

model Booking {
  id             Int      @id @default(autoincrement())
  listingId      Int
  buyerId        Int
  requestedStart DateTime
  requestedEnd   DateTime
  status         String   @default("PENDING") // 'PENDING','CONFIRMED','REJECTED','CANCELLED'
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])
  buyer   User    @relation("BuyerBookings", fields: [buyerId], references: [id])
}

model Message {
  id         Int      @id @default(autoincrement())
  listingId  Int
  senderId   Int
  receiverId Int
  content    String
  isFromAi   Boolean  @default(false)
  createdAt  DateTime @default(now())

  listing  Listing @relation(fields: [listingId], references: [id])
  sender   User    @relation("MessagesSent", fields: [senderId], references: [id])
  receiver User    @relation("MessagesReceived", fields: [receiverId], references: [id])
}

/**
 * =========================
 * ADS & EXPORTS (Module 6)
 * =========================
 */

model ListingAd {
  id              Int      @id @default(autoincrement())
  listingId       Int
  channel         String // 'AIPIX','FACEBOOK','PORTAL_X', etc.
  title           String
  description     String
  keywords        String?
  complianceScore Int?
  isActive        Boolean  @default(true)
  createdByAi     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])
}

model ListingExport {
  id            Int      @id @default(autoincrement())
  listingId     Int
  channel       String // partner identifier
  payloadFormat String // 'JSON','XML','CSV','PDF'
  status        String   @default("PENDING") // 'PENDING','SUCCESS','FAILED'
  externalUrl   String?
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])
}

/**
 * =========================
 * TRUST, SAFETY & MODERATION
 * =========================
 */

model ModerationFlag {
  id             Int      @id @default(autoincrement())
  listingId      Int?
  imageVersionId Int?
  raisedByUserId Int?
  source         String // 'AI','USER','SYSTEM'
  reasonCode     String // 'NSFW','DUPLICATE','FRAUD','TEXT_OVERLAY', etc.
  severity       String // 'LOW','MEDIUM','HIGH'
  details        String?
  resolved       Boolean  @default(false)
  createdAt      DateTime @default(now())

  listing      Listing?           @relation(fields: [listingId], references: [id])
  imageVersion ImageVersion?      @relation(fields: [imageVersionId], references: [id])
  raisedByUser User?              @relation("FlagsRaisedBy", fields: [raisedByUserId], references: [id])
  actions      ModerationAction[]
}

model ModerationAction {
  id          Int      @id @default(autoincrement())
  flagId      Int
  moderatorId Int
  actionType  String // 'APPROVE','REJECT','BLUR','REDACT'
  comment     String?
  createdAt   DateTime @default(now())

  flag      ModerationFlag @relation(fields: [flagId], references: [id])
  moderator User           @relation(fields: [moderatorId], references: [id])
}

/**
 * =========================
 * AUDIT LOGS
 * =========================
 */

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?
  entityType String // 'USER','LISTING','IMAGE','PLAN',...
  entityId   Int?
  action     String // 'CREATE','UPDATE','DELETE','LOGIN',...
  details    Json?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
